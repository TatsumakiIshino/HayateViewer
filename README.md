# HayateViewer

## 1. 概要

`HayateViewer`は、PythonとPySide6 (Qt) を基盤とする、高機能かつ高性能な画像ビューアアプリケーションです。特に、漫画やイラストの閲覧体験を向上させることに重点を置いており、見開き表示、主要な書庫フォーマット（ZIP, RAR, 7z）の直接読み込み、GPUアクセラレーションを活用した高品質な画像リサンプリングといった高度な機能を提供します。

アーキテクチャは、UIロジックとコアビジネスロジックを明確に分離したコンポーネントベース設計を採用しています。マルチスレッド処理と2層キャッシュシステム（CPU/GPU）を積極的に利用することで、UIの応答性を維持しつつ、巨大な画像ファイルや書庫ファイルでもスムーズなブラウジング体験を実現します。

## 2. 特徴

* **サクサク動く:** 巨大なファイルでも、素早い読み込みとスムーズなページめくりを実現します。
* **画像表示:**
  * 単一ページ表示
  * 見開き表示（左右綴じ対応、表紙の単独表示設定可）
  * フルスクリーン表示
  * ズーム、パン操作
* **対応フォーマット:**
  * 一般画像ファイル (JPEG, PNG, BMP, etc.)
  * 書庫ファイル (ZIP, RAR, 7z) の直接読み込み
* **高品質な画像リサンプリング:**
  * **CPUベース:** Pillow, OpenCV, scikit-imageを利用した複数のアルゴリズム（マルチスレッド対応）
  * **GPUベース (OpenGL/WGPU):** シェーダーによるリアルタイム・高品質リサンプリング
    * Nearest Neighbor
    * Bilinear
    * Lanczos-3
    * Quintic
* **パフォーマンス:**
  * CPU (L2) と GPU (L1) の2層キャッシュシステムによる高速な画像再表示
  * 先読み (Prefetching) 機構によるスムーズなページめくり
  * マルチスレッドによるファイルI/O、画像デコード、書庫展開の並列処理

## 3. 操作方法

### ファイルを開く

* **ドラッグ＆ドロップ:** エクスプローラーなどから、ファイルやフォルダを直接ウィンドウにドラッグ＆ドロップして開くことができます。

### ページの移動

* **マウスホイール:** ホイールを上下に回転させることで、ページを前後に移動できます。
* **キーボード:**
  * `→` : 次のページ
  * `←` : 前のページ
  * `Ctrl` + `→`/`←`: 見開き表示時でも1ページずつ強制的に移動します。
  * `Shift` + `→`/`←`: フォルダ単位で前後に移動します。
  * `Home`: 最初のページ
  * `End`: 最後のページ
* **ページジャンプ:**
  * `Shift+S`: 指定したページを直接指定して移動できます。
  * `S`: シークバーを開きます。ウィンドウ下部にあるバーをドラッグして、直感的にページを移動することもできます。

### 画面の操作

**キーボードショートカット:**

| キー | 機能 |
|:---|:---|
| `+` / `=` | 拡大 |
| `-` | 縮小 |
| `*` | ズームをリセット（全体表示） |
| `B` | 表示モードの切り替え（単一ページ → 右綴じ見開き → 左綴じ見開き） |
| `ALT+ENTER` | フルスクリーン表示のON/OFF |
| `ESC` | フルスクリーン表示を解除 |
| `Q` | アプリケーションを終了 |
| `F1` | バージョン情報を表示 |
| `O` | オプション画面（設定）を開きます |

**マウス操作:**

* **パン (表示位置の移動):**
  * 画像を拡大表示しているときに、マウスの **右ボタン** をドラッグすると、表示範囲を自由に動かせます。
* **ルーペ (一時的な拡大):**
  * マウスの **左ボタン** を押している間、カーソル位置が一時的に拡大されます。ボタンを離すと元の表示に戻ります。

## 4. 設定

HayateViewerの動作は、設定ダイアログ（`O`キー）または `config.json` ファイルを編集することでカスタマイズできます。

| 設定項目 | 説明 | デフォルト値 |
|:---|:---|:---|
| `rendering_backend` | 描画エンジンを選択します。`"opengl"` / `"wgpu"` はGPUを利用し高速・高画質です。`"pyside6_mt"` はCPUで描画し、互換性が高いです。 | `"pyside6_mt"` |
| `is_spread_view` | `true`で見開き表示、`false`で単一ページ表示になります。（`B`キーで動的に変更可能） | `true` |
| `binding_direction` | ページの綴じ方向を `left` (左綴じ) または `right` (右綴じ) で指定します。（`B`キーで動的に変更可能） | `"left"` |
| `spread_view_first_page_single` | 見開き表示のとき、1ページ目を単独で表示するかどうか。表紙を単独表示したい場合に `true` にします。 | `true` |
| `resampling_mode_gl` | GPU利用時の画質を選択します。<br>`"GL_NEAREST"`, `"GL_BILINEAR"`, `"GL_LANCZOS3"`, `"GL_QUINTIC"` など | `"GL_LANCZOS3"` |
| `resampling_mode_cpu` | CPU利用時の画質を選択します。<br>`"PIL_NEAREST"`, `"PIL_LANCZOS"`, `"SKIMAGE_ORDER_3"` など | `"PIL_LANCZOS"` |
| `max_cache_size_mb` | 画像を一時的に保存しておくメモリ（CPUキャッシュ）の最大サイズをMB単位で指定します。 | `4096` |
| `cpu_max_prefetch_pages` | 次に表示する可能性のあるページを、何ページ先まで事前に読み込んでおくかを指定します。 | `10` |
| `gpu_max_prefetch_pages` | GPU利用時に、GPUメモリに事前にテクスチャを準備しておくページ数を指定します。 | `9` |
| `parallel_decoding_workers` | 画像のデコードを並列処理するワーカースレッドの数。`0`で自動設定。 | `8` |
| `show_status_bar_info` | ステータスバーにキャッシュページなどの詳細情報を表示するかどうか。 | `true` |

## 5. 注意事項

* **RARファイルの対応:**
  * **Windows:** このアプリケーションをRARファイルに対応させるには、別途 `unrar.dll` (x64) が必要です。[rarlab.com](https://www.rarlab.com/rar_add.htm) の "UnRAR.dll" をダウンロードし、アプリケーションと同じディレクトリ（`main.py`がある場所）に配置してください。
  * **macOS:** `unrar` ライブラリが必要です。Homebrewを使用している場合、以下のコマンドでインストールできます。

        ```bash
        brew install unrar
        ```

        インストール後、環境変数 `UNRAR_LIB_PATH` の設定が必要になる場合があります。

## 6. トラブルシューティング

* **Q. 起動しない、またはエラーが出る。**
  * A. アプリケーションを再起動してみてください。それでも解決しない場合は、最新版を再ダウンロードしてください。また、Windows Defenderなどのセキュリティソフトによって実行がブロックされていないか確認してください。
* **Q. 書庫ファイルが開けない。**
  * A. ファイルが破損しているか、対応していない形式の可能性があります。RARの場合は `unrar.dll` (Windows) または `libunrar` (macOS) があるか確認してください。
* **Q. 動作が遅い。**
  * A. 設定を見直してみてください。
    * `rendering_backend` を `"pyside6_mt"` に変更してみる。
    * `resampling_mode_gl` をより軽量なもの（例: `"GL_BILINEAR"`）に変更する。
    * `max_cache_size_mb` や `cpu_max_prefetch_pages` の値を小さくする。
